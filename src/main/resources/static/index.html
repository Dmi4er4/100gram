<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>100gram</title>
    <base href="/">

    <script src="lib/angular.min.js"></script>
    <script src="lib/angular-route.min.js"></script>
    <script src="lib/angular-cookies.min.js"></script>

    <link rel="stylesheet" href="css/style.css">

    <script>
        const app = angular.module('myApp', ['ngRoute', 'ngCookies']);

        app.config(function($routeProvider, $locationProvider) {
            $routeProvider
                .when('/', {
                    template: '<h1>the Messenger of your Dream!</h1>' +
                        '<div class="container">' +
                        '    <button id="#btn-login" ng-click="navigateToLogin()"> Login </button>' +
                        '    <button id="#btn-register"> Register </button>' +
                        '</div>'
                })
                .when('/login', {
                    templateUrl: 'login.html',
                    controller: 'loginCtrl'
                })
                .when('/chat', {
                    templateUrl: 'chat.html',
                    controller: 'chatCtrl'
                })
                .otherwise({
                    redirectTo: '/'
                });

            $locationProvider.html5Mode(true);
        });

        app.controller('homeCtrl', function($scope, $location) {

        });

        app.controller('loginCtrl', function($scope, $cookies, $http) {
            $scope.credentials = {};

            $scope.loginRequest = function() {
                $http.post('/api/login', $scope.credentials)
                    .then(function(response) {
                        if (response.data.error) {
                            alert(response.data.error)
                        } else {
                            $cookies.put("name", response.data.name)
                            $cookies.put("uid", response.data.id)
                            $scope.navigateToChats()
                        }
                    })
                    .catch($scope.handleError);
            };
        });

        app.controller('chatCtrl', function($scope, $cookies, $http, $compile) {
            document.getElementById("introduction").innerText = 'You are ' + $cookies.get('name') +
                ' (id:' + $cookies.get('uid') + ')';

            $scope.addChat = function(chat) {
                const chatListElement = angular.element(document.getElementById('chat-list'));
                const newDiv = angular.element('<div>').addClass('chatlist-entry center-aligner hor');
                const chatNameElement = $compile('<h3></h3>')($scope);
                for (let member of chat.memberIds) {
                    if (member !== +$cookies.get('uid')) {
                        $scope.getUserByIdPromise(member).then(function(user) {
                            chatNameElement.text((chatNameElement.text().trim().length > 0 ? ', ' : '') + user.name);
                        })
                    }
                }
                newDiv.append(chatNameElement);
                chatListElement.append(newDiv);
            };

            $http.post('api/chats-list', $cookies.get('uid'))
                .then(function (response) {
                    for (let chat of response.data) {
                        $scope.addChat(chat);
                    }
                })
                .catch($scope.handleError);
        });

        app.run(function($rootScope, $location, $http) {
            $rootScope.usersMap = {}

            $rootScope.navigateToLogin = function() {
                $location.path('/login');
            };

            $rootScope.navigateToChats = function() {
                $location.path('/chat');
            };

            $rootScope.getUserByIdPromise = function(id) {
                if ($rootScope.usersMap[id] === undefined) {
                    return $http.post('/api/user', id)
                        .then(function (response) {
                            $rootScope.usersMap[id] = response.data;
                            return $rootScope.usersMap[id];
                        })
                        .catch($rootScope.handleError)
                }
                return $rootScope.usersMap[id]
            };

            $rootScope.handleError = function (error) {
                if (error.status === 401) {
                    $rootScope.navigateToLogin();
                }
            };
        });
    </script>
</head>
<body ng-app="myApp">
<main ng-view>
</main>
</body>
</html>
